<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>AI Tutor Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #121212;
      color: #f1f1f1;
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
    }

    h2 {
      color: #00ffcc;
      margin-bottom: 20px;
      text-align: center;
    }

    #chat {
      border: 1px solid #333;
      padding: 15px;
      height: 400px;
      overflow-y: scroll;
      background: #1e1e1e;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 255, 204, 0.1);
      margin-bottom: 15px;
    }

    .message {
      margin-bottom: 15px;
    }

    .user {
      font-weight: bold;
      color: #00ffcc;
    }

    .bot {
      font-weight: bold;
      color: #ffaa33;
    }

    .content {
      margin-left: 10px;
      color: #e0e0e0;
    }

    #input-area {
      display: flex;
      gap: 10px;
    }

    #message-input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background-color: #2b2b2b;
      color: #f1f1f1;
    }

    #send-btn {
      padding: 10px 20px;
      background-color: #00ffcc;
      color: #1a1a1a;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #send-btn:hover {
      background-color: #00e6b8;
    }

    .save-btn {
      margin-top: 5px;
      padding: 6px 12px;
      background-color: #ffaa33;
      color: #1a1a1a;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    .save-btn:hover {
      background-color: #e69500;
    }

    a button {
      background-color: #333;
      color: #f1f1f1;
      border: 1px solid #555;
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #top-buttons {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}


    a button:hover {
      background-color: #444;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

  <h2>AI Tutor Chatbot</h2>

<div id="top-buttons">
 
  <a href="{% url 'user_dashboard' %}">
    <button>‚Üê Back to Dashboard</button>
  </a>

   <a href="{% url 'view_notes' %}">
    <button>üóíÔ∏è View My Saved Notes</button>
  </a>
</div>


  <div id="chat"></div>

  <div id="input-area">
    <input type="text" id="message-input" placeholder="Type your question here..." />
    <button id="send-btn">Send</button>
  </div>

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie("csrftoken");
    const chatUrl = "{% url 'chat_api' %}";
    const saveNoteUrl = "{% url 'save_note' %}";

    const chatDiv = document.getElementById("chat");
    const input = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");

    function appendMessage(sender, text) {
      const div = document.createElement("div");
      div.classList.add("message");
      div.innerHTML = `<span class="${sender}">${sender === 'user' ? 'You' : 'Bot'}:</span> <span class="content">${marked.parse(text)}</span>`;
      chatDiv.appendChild(div);

      if (sender === "bot") {
        const saveBtn = document.createElement("button");
        saveBtn.classList.add("save-btn");
        saveBtn.textContent = "üìå Save This Reply";
        saveBtn.onclick = () => {
          fetch(saveNoteUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ content: text })
          })
            .then(res => res.json())
            .then(data => {
              if (data.message) {
                alert("‚úÖ Saved to your notes!");
              } else {
                alert("‚ö†Ô∏è Error: " + data.error);
              }
            })
            .catch(() => alert("‚ö†Ô∏è Something went wrong."));
        };
        div.appendChild(document.createElement("br"));
        div.appendChild(saveBtn);
      }

      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;

      appendMessage("user", message);
      input.value = "";
      input.disabled = true;
      sendBtn.disabled = true;

      const typingDiv = document.createElement("div");
      typingDiv.classList.add("message", "bot");
      typingDiv.id = "typing-indicator";
      typingDiv.innerHTML = `<span class="bot">Bot:</span> <span class="content">Typing<span id="dots"></span></span>`;
      chatDiv.appendChild(typingDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;

      let dots = "";
      const dotsElement = typingDiv.querySelector("#dots");
      const interval = setInterval(() => {
        dots = dots.length < 3 ? dots + "." : "";
        dotsElement.textContent = dots;
      }, 500);

      try {
        const res = await fetch(chatUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({ message }),
        });

        const data = await res.json();

        clearInterval(interval);
        typingDiv.remove();

        if (data.reply) {
          appendMessage("bot", data.reply);
        } else if (data.error) {
          appendMessage("bot", `Error: ${data.error}`);
        }
      } catch (e) {
        clearInterval(interval);
        typingDiv.remove();
        appendMessage("bot", "Error connecting to server.");
      }

      input.disabled = false;
      sendBtn.disabled = false;
      input.focus();
    }

    sendBtn.addEventListener("click", sendMessage);

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    input.focus();
  </script>

</body>

</html>
